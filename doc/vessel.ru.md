# Протокол Vessel

> Предварительная спецификация протокола Vessel.

## Введение

Протокол Vessel - это децентрализованный протокол, описывающий жизненный цикл самостоятельно-управляемых (или коротко _самоуправляемых_) документов поверх протокола [Ceramic](https://ceramic.network). Самоуправляемый документ представляет собой присоединяющую (append-only) последовательность подписанных записей изменений (дельты), которые якорятся на блокчейне. Он содержит _собственно данные_ (тело) документа в виде набора изменений, а также правила корректных изменений как тип документа. Правила изменений могут в свою очередь являться самостоятельно-управляемым документом, содержание которого есть исполняемый программный код. Это позволяет узлам протокола валидировать документ децентрализованным образом. При изменении документа узлы протокола распространяют дельты, и узлы, заинтересованные в документе, могут самостоетельно определять, может ли изменение быть применено для получения нового состояния документа. Не существует единого глобального списка документов. Узел вправе самостоятельно решать, в получении каких документов он заинтересован.

Примером самостоятельно-управляемого документа может являться соглашение между двумя компаниями. Тело соглашения включает договор, счет-фактуру и закрывающий акт. Правила изменений подразумевают жизненный цикл изменений договор->счёт->акт при условии подписания их обеими сторонами и соответствия сумм в счете и акте сумме договора.

## Основания

Протокол построен на основе протокола [Ceramic](https://www.ceramic.network) и расширяет его, включая правила изменения как самоуправляемый документ. Для описания протокола потребуется упомянуть несколько понятий.

**Хеш** - слепок содержимого файла, является результатом процедуры _хеширования_, которая преобразует всё содержимое файла в относительно короткое число; хеш существенно зависит от содержимого - при малейшем изменении в содержимом, хеш значительно изменяется; из хеша невозможно восстановить содержимое файла.

**[IPFS](https://ipfs.io)** - распределённое контентно-адресуемое хранилище данных, то есть файловая система, в которой именем файла является хеш от его содержимого.

**[CID](https://github.com/multiformats/cid)** - формат идентификатора объекта в контентно-адресумом хранилище данных.

**[IPLD](https://ipld.io)** - модель данных интероперабельных протоколов. Специфицировает правила кодировки данных, адресов и запросов.

**[Цифровая подпись](https://ru.wikipedia.org/wiki/Электронная_подпись)** - электронно-цифровая подпись, созданная в рамках криптосистемы с открытым ключом.

**[Merkle DAG](https://docs.ipfs.io/guides/concepts/merkle-dag/)** - направленный ациклический граф, в котором узлы связаны друг с другом через контент-адресуемые ссылки, закодированные через IPLD.

**Песочница** - специально изолированная среда для безопасного выполнения компьютерных программ.

**Якорение** - способ обеспечить безотзывность документа через сохранение его хеша на блокчейне.

## Жизненный цикл документа

При всём многообразии жизненного цикла документов, можно вывести общее. Документ состоит из последовательности записей: начальная запись, обновляющая запись, якорная запись. Над документом можно провести три основных операции: _создать_, _обновить_, _запросить_.

![vessel](./vessel.png)

### Создание документа

При создании документа создаётся IPLD-объект, который содержит первоначальное тело. Это так называемая начальная запись. Её CID используется далее как идентификатор документа (_docId_). В зависимости от типа документа, на содержимое начальной записи могут быть наложены ограничения.

### Обновление документа

Обновление документа состоит из двух записей, последовательно добавленных в последовательность записей. Во-первых, добавляется _Обновляющая запись_.. Результирующий CID посылается в якорный сервис, который сохраняет хеш документа на блокчейне. Якорный сервис затем возвращает якорную запись. Она добавляется к последовательности документа и широковещательно публикуется.

### Запрос документа

Для запроса документа необходимо знать его _docId_. Следует послать этот _docId_ в PubSub топик. Другие узлы протокола ответят последними известными CID для этого документа. Запросивший узел затем запрашивает CID и восстанавливает полную последовательность записей. Если есть конфликты, они разрешаются механизмом разрешения конфликтов.

## Идентификатор документа

Каждый документ имеет идентификатор (_docId_). Он не меняется за время жизненного цикла документа. Идентификатор - это строка формата:

```
ceramic://<CID>
```

Здесь `<CID>` - это CID начальной записи документа.

### Версия

Каждая дополнительная запись порождает новую версию документа. К ней можно обращаться как

```
ceramic://<CID>?version=<version-cid>
```

Здесь `<version-cid>` - это CID последней записи в последовательности.

В случае, если `<version-cid>` соответствует якорной записи, следует говорить о якорной версии документа.

## Последовательность записей документа

Документ протокола представляет собой дополняемую последовательность записей, которые можно  свести в один объект JSON. Каждая запись представляет собой IPLD-объект, который идентифицируется по его CID. Каждая запись (кроме начальной) ссылается на предыдущую в последовательности через CID предыдущей записи, что даёт свойство неизменного прошлого для документа. Одновременно у документа может быть несколько _последних_ записей, что адресуется в разделе о разрешении конфликтов. В протоколе выделены три вида записей: начальная запись, обновляющая запись, якорная запись.

### Начальная запись

Объявляет начало документа. Содержит три свойства: `doctype`, `owners`, `content`. `doctype` - это строка, определяющая тип данного документа. `owners` фиксирует владельцев документа. Содержит 1+ [DID](https://www.w3.org/TR/did-core/). `content` содержит тело документа, определяемое его типом. Общая структура:

```json
{
	"doctype": "<doctype-string>",
	"owners": ["<1-plus-owner-did>"],
	"content": <content>
}
```

### Обновляющая запись

Обновляющая запись содержит указатель на предыдущую запись как CID в поле `prev`, дельту изменений содержимого документа в поле `content`, и подпись. Формат хранения подписи может зависеть от типа документа.

```json
{
	"prev": "<prev-CID>",
	"content": <patch>
}
```

TBD Подпись

### Якорная запись

Якорная запись представляет доказательство того, что документ был якорен на блокчейне. Содержит ссылку на CID предыдущей записи в поле `prev`. Поле `proof` содержит CID доказательства факта якорения. По технологии якорения, доказательство является общим для всех документов, которые попали в одно дерево Меркла на одном блокчейне. Поле `path` является путём до листа в дереве доказательства, который содержит CID, упомянутый в поле `prev`.

```json
{
	"prev": "<CID-prev>",
	"proof": "<CID-proof>",
	"path": "<path>"
}
```

#### Доказательство

Формат документа с доказательством приведён ниже. `chainId` представляет собой уникальный идентификатор блокчейна, на котором произошло якорение, в соответствии с [CAIP-2](https://github.com/ChainAgnostic/CAIPs/blob/master/CAIPs/caip-2.md). `blockNumber` содержит номер блока, `blockTimestamp` содержит время создания блока как unix timestamp. Поля `blockNumber` и `blockTimestamp` не валидируются и присутствуют только для информационных целей. Поле `txHash` содержит CID блокчейновой транзакции, в которой присутствует CID корня дерева Меркла. Используя эту транзакцию независимое третье лицо может самостоятельно проверить валидность доказательства. Поле `root` содержит CID корня дерева Меркла.

```
{
"chainId": "<caip-2-blockchain>",
"blockNumber": <int-blocknumber>,
"blockTimestamp": <int-unix-timestamp>,
"txHash": "<CID-tx-hash>",
"root": "<CID-merkle-root>"
}
```

# Типы документов

Каждый документ в рамках протокола обязан специфицировать тип документа как `doctype`. Он определяет правила, по которым совершаются изменение содержания документа.

Данный документ определяет два типа документов:

`/vessel/document.ruleset/0.1` - определяет правила изменения документа в виде исполняемого кода,

`/vessel/document/0.1` - самоуправляемый документ, правила изменения которого записаны в связанном документе `vessel/document.ruleset/0.1`.

Так как протокол базируется на протоколе Ceramic, он включает в себя все его типы документов.

В то время, как протокол фиксирует формат данных и возможные изменения документов, семантика документа остаётся за конечным пользовательским приложением.

**Замечание по именованию типов**

Так как может существовать большее количество типов документов и принимая во внимание развитие типов документов, условимся о следующем соглашении типов. Тип документа состоит из трёх частей, разделённых символом `/`: 

```
<vendor>/<type>/<version>
```

- `<vendor>` - цифробуквенная последовательность вендора, предложившего протокол, должно начинаться с буквы, должно содержать только символы `[a-z0-9\.]`, обязательна
- `<type>` - собственно тип документа, обязательна, только символы `[a-z\.]` в нижнем регистре,
- `<version>` - semver-версия типа.

## Ruleset

**Тип документа**: `vessel/ruleset/0.1`.

> Определяет исполняемые правила валидации документа

### Начальная запись

Поле `owners` содержит 1+ набор владельцев документа, в виде DID. Поле `content` содержит следующие поля:

- `language` - строка, MIME-подобный-тип исполняемого кода, обязательный

- `main` - CID документа, содержащего исполняемый код, обязательный
- `schema` - CID документа, содержащего JSON-схему, описывающую формат тела документа, обязательно
- `name` - строка, имя пакета, обязательно, формат TBD
- `version` - строка, версия кода в формате SemVer, необязательно
- `description` - строка, описание кода, необязательно
- `keywords` -  массив строк, необязательно
- `homepage` - адрес домашней страницы проекта
- `bugs` - адрес для обратной связи, см [NPM](https://docs.npmjs.com/files/package.json#bugs)
- `repository` - адрес с местом, где живёт код, см [NPM](https://docs.npmjs.com/files/package.json#repository)

Документ `vessel/ruleset/0.1` поддерживает в поле `language` только `text/javascript`. В нём содержится программный код на языке JavaScript, исполняемый в Node.js 12 (TBD, узкое место). Он исполняется в рамках контейнера [SES](https://github.com/Agoric/SES-shim/). Код должен экспортировать функцию `canApply` (через `module.exports = {canApply: <func>}`), которая принимает два параметра - текущее тело документа и его следующую версию. Функция должна вернуть булево значение: `true` указывает на корректное изменение, `false` - на некорректное.

### Обновляющая запись

Обновляющая запись содержит изменение к содержимому документа в виде [json-patch](https://github.com/Starcounter-Jack/JSON-Patch), подписанное одним из DID в поле `owners`. Обновляющая запись может менять поля `language`, `main`, `schema`, что может привести к неработоспособности документа. Управление этим риском остаётся на ответственности владельца документа `vessel/document/1.0`.

## Document

**Тип документа**: `vessel/document/1.0`

> Определяет документ, жизненный цикл которого определяется в связанном ruleset.

### Начальная запись

Поле `owners` содержит список из 1+ DID владельцев документа.  Поле `content` содержит следующие поля:

- `governance` - идентификатор документа ruleset в виде `ceramic://<docId>`
- `body` - JSON-объект, подчиняющийся схеме из Ruleset.

### Обновляющая запись

Обновляющая запись содержит изменение к содержимому документа в виде [json-patch](https://github.com/Starcounter-Jack/JSON-Patch), подписанное одним из DID в поле `owners`. Обновляющая запись может быть присоединена к последовательности документов только, если `canApply` из ruleset возвращает `true`.
